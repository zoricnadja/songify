import json
import boto3
import os
from boto3.dynamodb.conditions import Key

dynamodb = boto3.resource('dynamodb')
subscriptions_table = dynamodb.Table(os.environ['SUBSCRIPTIONS_TABLE'])
ses = boto3.client("ses", region_name=os.environ.get("SES_REGION", "eu-central-1"))
SES_SOURCE_EMAIL = os.environ["SES_SOURCE_EMAIL"]

def send_email(recipient, subject, body):
    ses.send_email(
        Source=SES_SOURCE_EMAIL,
        Destination={"ToAddresses": [recipient]},
        Message={"Subject": {"Data": subject}, "Body": {"Text": {"Data": body}}},
    )

def lambda_handler(event, context):
    for record in event["Records"]:
        sns_message = json.loads(record["Sns"]["Message"])
        event_type = sns_message.get("type")
        data = sns_message.get("data")

        genres = data.get("genres", [])
        artists = data.get("artists", [])
        notified_emails = set()

        if event_type == "track":
            subject_template = "New track notification"
            body_template = f"New track '{data['track_name']}' was released!"
        elif event_type == "album":
            subject_template = "New album notification"
            body_template = f"New album '{data['album_name']}' was released!"
        else:
            continue  # nepoznat tip

        for genre in genres:
            res = subscriptions_table.query(
                KeyConditionExpression=Key("target").eq(f"genre#{genre}")
            )
            for user in res.get("Items", []):
                email = user.get("email")
                if email and email not in notified_emails:
                    send_email(email, subject_template, body_template)
                    notified_emails.add(email)

        for artist in artists:
            res = subscriptions_table.query(
                KeyConditionExpression=Key("target").eq(f"artist#{artist}")
            )
            for user in res.get("Items", []):
                email = user.get("email")
                if email and email not in notified_emails:
                    send_email(email, subject_template, body_template)
                    notified_emails.add(email)

    return {"statusCode": 200, "body": "Notifications processed"}
